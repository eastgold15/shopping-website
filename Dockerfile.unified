# ç»Ÿä¸€éƒ¨ç½² Dockerfile
# åŒ…å«å‰ç«¯ã€åç«¯å’Œ Caddy åå‘ä»£ç†çš„å®Œæ•´é•œåƒ

# ================================
# é˜¶æ®µ1: å‰ç«¯æ„å»º
# ================================
FROM node:18-alpine AS frontend-builder

WORKDIR /app

# å®‰è£… pnpm
RUN npm install -g pnpm

# å¤åˆ¶å‰ç«¯é¡¹ç›®æ–‡ä»¶
COPY apps/frontend/package.json apps/frontend/pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# å¤åˆ¶å‰ç«¯æºç å¹¶æ„å»º
COPY apps/frontend/ ./
RUN pnpm run build

# ================================
# é˜¶æ®µ2: åç«¯æ„å»º
# ================================
FROM oven/bun:1-alpine AS backend-builder

WORKDIR /app

# å¤åˆ¶åç«¯é¡¹ç›®æ–‡ä»¶
COPY apps/backend/package.json apps/backend/bun.lockb ./
RUN bun install --frozen-lockfile

# å¤åˆ¶åç«¯æºç 
COPY apps/backend/ ./

# æ„å»ºåç«¯å¯æ‰§è¡Œæ–‡ä»¶
RUN bun build --compile --target bun --outfile server index.ts

# ================================
# é˜¶æ®µ3: æœ€ç»ˆé•œåƒ - åŸºäº Caddy
# ================================
FROM caddy:2-alpine

# å®‰è£…å¿…è¦å·¥å…·
RUN apk add --no-cache wget curl

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# ä»åç«¯æ„å»ºé˜¶æ®µå¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
COPY --from=backend-builder /app/server /app/server
COPY --from=backend-builder /app/public /app/public

# ä»å‰ç«¯æ„å»ºé˜¶æ®µå¤åˆ¶é™æ€æ–‡ä»¶
COPY --from=frontend-builder /app/dist /var/www/frontend

# åˆ›å»ºä¸Šä¼ ç›®å½•
RUN mkdir -p /var/www/uploads

# å¤åˆ¶ Caddyfile é…ç½®ï¼ˆå†…ç½®åˆ°é•œåƒä¸­ï¼‰
COPY <<EOF /etc/caddy/Caddyfile
# ç»Ÿä¸€éƒ¨ç½² Caddyfile é…ç½®
# å‰ç«¯å’Œåç«¯æœåŠ¡çš„åå‘ä»£ç†é…ç½®

# ä¸»åŸŸå - å‰ç«¯æœåŠ¡
{\$DOMAIN:localhost} {
    # åç«¯ API è·¯å¾„
    handle_path /api/* {
        reverse_proxy localhost:3001 {
            health_uri /health
            health_interval 30s
            health_timeout 5s
        }
    }

    # ä¸Šä¼ æ–‡ä»¶æœåŠ¡
    handle_path /uploads/* {
        root * /var/www
        file_server
        header {
            Cache-Control "public, max-age=86400"
        }
    }

    # å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡
    handle {
        root * /var/www/frontend
        
        # é™æ€èµ„æºç¼“å­˜
        @static {
            path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
        }
        header @static {
            Cache-Control "public, max-age=31536000, immutable"
        }
        
        # å¯ç”¨å‹ç¼©
        encode gzip zstd
        
        # é™æ€æ–‡ä»¶æœåŠ¡
        file_server
        
        # SPA è·¯ç”±å›é€€
        try_files {path} /index.html
    }

    # å®‰å…¨å¤´
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    # æ—¥å¿—
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# å¼€å‘ç¯å¢ƒç«¯å£è®¿é—®
:80 {
    redir https://{host}{uri} permanent
}

# å¥åº·æ£€æŸ¥ç«¯ç‚¹
:2019 {
    metrics /metrics
}
EOF

# åˆ›å»ºå¯åŠ¨è„šæœ¬
COPY <<EOF /app/start.sh
#!/bin/sh
set -e

echo "ğŸš€ å¯åŠ¨ç»Ÿä¸€éƒ¨ç½²æœåŠ¡..."

# å¯åŠ¨åç«¯æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
echo "ğŸ“± å¯åŠ¨åç«¯æœåŠ¡..."
cd /app
./server &
BACKEND_PID=\$!

# ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
sleep 5

# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸
for i in \$(seq 1 10); do
    if wget -q --spider http://localhost:3001/health 2>/dev/null; then
        echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
        break
    fi
    echo "â³ ç­‰å¾…åç«¯æœåŠ¡... (\$i/10)"
    sleep 2
done

# å¯åŠ¨ Caddyï¼ˆå‰å°è¿è¡Œï¼‰
echo "ğŸŒ å¯åŠ¨ Caddy åå‘ä»£ç†..."
exec caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
EOF

# è®¾ç½®æ‰§è¡Œæƒé™
RUN chmod +x /app/start.sh /app/server

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p /var/log/caddy

# æš´éœ²ç«¯å£
EXPOSE 80 443 2019

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD wget -q --spider http://localhost/api/health || exit 1

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV APP_PORT=3001
ENV DOMAIN=localhost

# å¯åŠ¨æœåŠ¡
CMD ["/app/start.sh"]