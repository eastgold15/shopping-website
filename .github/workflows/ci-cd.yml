name: CI/CD Pipeline

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ°mainåˆ†æ”¯æˆ–åˆ›å»ºPR
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# çŽ¯å¢ƒå˜é‡
env:
  REGISTRY: registry.cn-chengdu.aliyuncs.com
  IMAGE_NAME: docker-tzd/mechanicendworld
  NODE_VERSION: '18'
  PNPM_VERSION: '10.4.0'
  BUN_VERSION: '1.2.21'

jobs:
  # æ£€æµ‹å˜åŒ–çš„æ–‡ä»¶
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      packages: ${{ steps.changes.outputs.packages }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
            backend:
              - 'apps/backend/**'
            packages:
              - 'packages/**'

  # å‰ç«¯CI/CD
  frontend-ci-cd:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.packages == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Get pnpm store directory
      shell: bash
      run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: ${{ runner.os }}-pnpm-store-

    - name: Install frontend dependencies
      run: |
        cd apps/frontend
        pnpm install --frozen-lockfile

    - name: Frontend type check
      run: |
        cd apps/frontend
        pnpm run type-check

    - name: Frontend lint
      run: |
        cd apps/frontend
        pnpm run lint

    - name: Build frontend
      run: |
        cd apps/frontend
        pnpm run build
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:3001' }}
        VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}

    # ä»…åœ¨æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶éƒ¨ç½²åˆ°Caddy
    - name: Deploy frontend to Caddy
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        cd apps/frontend
        tar -czf frontend-dist.tar.gz -C dist .

    - name: Upload frontend to server
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "apps/frontend/frontend-dist.tar.gz"
        target: "/tmp/"

    - name: Deploy frontend to Caddy server
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          DEPLOY_DIR="${{ secrets.FRONTEND_DEPLOY_PATH || '/1/MechanicEndWorld2/front' }}"
          BACKUP_DIR="${DEPLOY_DIR}-backup-$(date +%Y%m%d-%H%M%S)"
          
          mkdir -p $DEPLOY_DIR
          
          if [ -d "$DEPLOY_DIR" ] && [ "$(ls -A $DEPLOY_DIR)" ]; then
            cp -r $DEPLOY_DIR $BACKUP_DIR
          fi
          
          rm -rf $DEPLOY_DIR/*
          cd $DEPLOY_DIR
          tar -xzf /tmp/apps/frontend/frontend-dist.tar.gz
          chown -R $USER:$USER $DEPLOY_DIR
          chmod -R 755 $DEPLOY_DIR
          rm -f /tmp/apps/frontend/frontend-dist.tar.gz
          
          echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆï¼ŒCaddyå°†è‡ªåŠ¨æä¾›æ–°ç‰ˆæœ¬"
          
          ls -t ${DEPLOY_DIR%/*}/*-backup-* 2>/dev/null | tail -n +6 | xargs rm -rf || true

  # åŽç«¯CI/CD
  backend-ci-cd:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.packages == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: ${{ env.BUN_VERSION }}

    - name: Install backend dependencies
      run: |
        cd apps/backend
        bun install

    - name: Backend type check
      run: |
        cd apps/backend
        bun run type-check

    - name: Build backend
      run: |
        cd apps/backend
        bun run build

    - name: Set up Docker Buildx
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: docker/setup-buildx-action@v3

    - name: Login to Alibaba Cloud Container Registry
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
        password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

    - name: Build and push Docker image
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: docker/build-push-action@v5
      with:
        context: apps/backend
        file: apps/backend/.container/prod/Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy backend to server
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd ${{ secrets.BACKEND_DEPLOY_PATH || '/path/to/your/project/backend' }}
          
          export IMAGE_TAG=${{ github.sha }}
          
          # ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
          if [ ! -f ".container/prod/docker-compose.prod.yml" ]; then
            echo "âŒ Docker Composeé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker-compose -f .container/prod/docker-compose.prod.yml pull
          
          # é‡å¯æœåŠ¡ï¼ˆåŒ…æ‹¬Caddyï¼‰
          docker-compose -f .container/prod/docker-compose.prod.yml up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 10
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          docker-compose -f .container/prod/docker-compose.prod.yml ps
          
          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f
          
          echo "âœ… åŽç«¯å’ŒCaddyæœåŠ¡éƒ¨ç½²å®Œæˆ"

  # å¥åº·æ£€æŸ¥å’Œé€šçŸ¥
  health-check:
    needs: [frontend-ci-cd, backend-ci-cd]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    
    steps:
    - name: Frontend health check
      if: needs.frontend-ci-cd.result == 'success'
      run: |
        echo "ðŸ” æ£€æŸ¥å‰ç«¯æœåŠ¡å¥åº·çŠ¶æ€..."
        for i in {1..5}; do
          if curl -f http://${{ secrets.SSH_HOST }}:9010/health; then
            echo "âœ… å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          fi
          echo "â³ ç­‰å¾…å‰ç«¯æœåŠ¡å¯åŠ¨... ($i/5)"
          sleep 10
        done
      continue-on-error: true

    - name: Backend health check
      if: needs.backend-ci-cd.result == 'success'
      run: |
        echo "ðŸ” æ£€æŸ¥åŽç«¯APIæœåŠ¡å¥åº·çŠ¶æ€..."
        for i in {1..5}; do
          # é€šè¿‡Caddyä»£ç†æ£€æŸ¥åŽç«¯å¥åº·çŠ¶æ€
          if curl -f http://${{ secrets.SSH_HOST }}/api/health || curl -f http://${{ secrets.SSH_HOST }}:${{ secrets.APP_PORT || 3001 }}/health; then
            echo "âœ… åŽç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          fi
          echo "â³ ç­‰å¾…åŽç«¯æœåŠ¡å¯åŠ¨... ($i/5)"
          sleep 10
        done
      continue-on-error: true

    - name: Deployment summary
      run: |
        echo "## ðŸš€ éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.frontend-ci-cd.result }}" == "success" ]; then
          echo "âœ… **å‰ç«¯éƒ¨ç½²**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **å‰ç«¯åœ°å€**: ${{ secrets.FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.frontend-ci-cd.result }}" == "skipped" ]; then
          echo "â­ï¸ **å‰ç«¯éƒ¨ç½²**: è·³è¿‡ï¼ˆæ— å˜åŒ–ï¼‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **å‰ç«¯éƒ¨ç½²**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.backend-ci-cd.result }}" == "success" ]; then
          echo "âœ… **åŽç«¯éƒ¨ç½²**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **åŽç«¯åœ°å€**: ${{ secrets.BACKEND_URL }}" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.backend-ci-cd.result }}" == "skipped" ]; then
          echo "â­ï¸ **åŽç«¯éƒ¨ç½²**: è·³è¿‡ï¼ˆæ— å˜åŒ–ï¼‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **åŽç«¯éƒ¨ç½²**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ **æäº¤è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY