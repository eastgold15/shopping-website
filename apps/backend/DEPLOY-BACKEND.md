# 后端部署说明

## 功能特性

- 基于 SFTP 协议的安全文件传输
- 自动构建和部署后端项目
- 部署必需文件：package.json、环境变量、构建产物
- 自动创建启动脚本
- 完整的服务管理脚本（启动、停止、状态检查）
- 自动权限设置和日志管理

## 部署文件

脚本会部署以下文件到服务器 `/1` 目录：
- `package.json` - 项目依赖配置
- `.env` - 基础环境变量
- `.env.production` - 生产环境配置
- `index.js` - 构建后的应用程序
- `start.sh` - 启动脚本
- `stop.sh` - 停止脚本
- `status.sh` - 状态检查脚本

## 安装依赖

```bash
bun install
```

## 部署方法

### 使用环境变量文件部署

```bash
# 使用预配置的环境变量
bun run deploy:prod
```

### 直接运行部署脚本

```bash
# 使用默认配置
node deploy-backend.js

# 自定义服务器配置
node deploy-backend.js --host 139.196.30.42 --user root --password Xlw123## --path /1
```

## 服务器端操作

### 部署完成后，在服务器上执行：

```bash
# 进入部署目录
cd /1

# 启动服务
./start.sh

# 检查状态
./status.sh

# 查看日志
tail -f logs/app.log

# 停止服务
./stop.sh
```

## 服务管理脚本

### start.sh - 启动脚本
- 自动安装依赖
- 使用环境变量启动服务
- 后台运行并记录日志
- 自动检查服务状态

### stop.sh - 停止脚本
- 优雅停止服务
- 清理进程文件
- 记录停止日志

### status.sh - 状态检查
- 检查服务运行状态
- 显示进程信息
- 检查系统资源
- 验证文件完整性

## 配置选项

### 环境变量配置

| 变量名 | 描述 | 默认值 |
|--------|------|--------|
| `SFTP_HOST` | SFTP服务器地址 | `139.196.30.42` |
| `SFTP_PORT` | SFTP服务器端口 | `22` |
| `SFTP_USER` | SFTP用户名 | `root` |
| `SFTP_PASSWORD` | SFTP密码 | `Xlw123##` |
| `REMOTE_PATH` | 远程部署路径 | `/1` |

### 命令行参数

```bash
node deploy-backend.js --host <地址> --port <端口> --user <用户名> --password <密码> --path <路径>
```

## 部署流程

1. **检查必需文件** - 验证本地文件完整性
2. **构建项目** - 运行 `bun run build` 生成 index.js
3. **连接SFTP** - 建立安全连接
4. **准备远程目录** - 创建并清理目标目录
5. **上传文件** - 传输所有必需文件
6. **创建管理脚本** - 生成启动、停止、状态脚本
7. **设置权限** - 配置文件和目录权限
8. **验证部署** - 检查部署结果

## 日志管理

服务启动后会创建以下日志文件：
- `logs/app.log` - 应用运行日志
- `logs/start.log` - 启动记录
- `logs/stop.log` - 停止记录
- `app.pid` - 进程ID文件

## 故障排除

### 常见问题

1. **SFTP连接失败**
   - 检查服务器地址和端口
   - 验证用户名和密码
   - 确保防火墙允许SFTP连接

2. **服务启动失败**
   - 检查bun是否安装
   - 验证环境变量配置
   - 查看应用日志

3. **端口占用**
   - 使用 `./stop.sh` 停止现有服务
   - 检查端口9004是否被其他进程占用

### 调试命令

```bash
# 检查端口占用
lsof -i:9004

# 查看进程
ps aux | grep index.js

# 查看系统资源
top
free -h

# 测试服务连接
curl http://localhost:9004
```

## 安全建议

1. **不要将 `.env` 文件提交到版本控制**
2. **使用强密码和SSH密钥认证**
3. **限制服务器用户权限**
4. **定期更新依赖和系统**
5. **监控服务运行状态**

## 服务配置

- **运行端口**: 9004
- **进程管理**: 使用启动脚本管理
- **日志记录**: 自动记录到 logs/ 目录
- **环境变量**: 加载 .env 和 .env.production
- **依赖管理**: 自动安装 node_modules

## 注意事项

- 确保服务器已安装bun运行时
- 网络连接稳定，避免上传中断
- 定期备份服务器上的重要数据
- 监控服务运行状态和资源使用